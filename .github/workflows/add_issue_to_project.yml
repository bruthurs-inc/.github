name: Update Operations Issue Fields
on:
  issues:
    types: [opened]

jobs:
  update-fields:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, 'triage')
    steps:
      - name: Extract Fields from Issue Body
        id: extract_fields
        run: |
          DUE_DATE=$(awk -v RS="" '/### Due Date/ {print $3}' <<< "${{ github.event.issue.body }}")
          PRIORITY=$(awk -v RS="" '/### Priority/ {print $3,$4,$5,$6,$7}' <<< "${{ github.event.issue.body }}")
          EFFORT=$(awk -v RS="" '/### Level of Effort/ {print $4,$5,$6}' <<< "${{ github.event.issue.body }}")

          echo "DUE_DATE=$DUE_DATE" >> $GITHUB_ENV
          echo "PRIORITY=$PRIORITY" >> $GITHUB_ENV
          echo "EFFORT=$EFFORT" >> $GITHUB_ENV

      - name: Update Project Fields
        run: |
          gh project item-update "$PROJECT_ID" --owner "$OWNER" --item-id "$ISSUE_ID" \
            --field "Due Date=$DUE_DATE" \
            --field "Priority=$PRIORITY" \
            --field "Level of Effort=$EFFORT"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PROJECT_ID: "2"
          OWNER: "bruthurs-inc"
          ISSUE_ID: ${{ github.event.issue.node_id }}
